%% corrected code from David conform
%% converted from C++
%% emailed by author